services:

  mariadb:
    image: 'mariadb:11.4'
    container_name: wp-db
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${WP_DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${WP_DB_NAME}
      - MYSQL_USER=${WP_DB_USER}
      - MYSQL_PASSWORD=${WP_DB_PASSWORD}
      - MARIADB_CHARACTER_SET=utf8mb4
      - MARIADB_COLLATE=utf8mb4_unicode_ci
    volumes:
      - 'mariadb-data:/var/lib/mysql'
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost",
             "-u", "root", "-p${WP_DB_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - wp_net

  redis:
    image: 'redis:7.4-alpine'
    container_name: wp-redis
    restart: unless-stopped
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD_WP}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save ""
    volumes:
      - 'redis-data:/data'
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD_WP}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - wp_net

  wordpress:
    image: 'wordpress:6.7-php8.3-apache'
    container_name: wp-app
    restart: unless-stopped
    depends_on:
      mariadb:
        condition: service_healthy
      redis:
        condition: service_healthy
    expose:
      - '80'
    environment:
      - WORDPRESS_DB_HOST=mariadb:3306
      - WORDPRESS_DB_NAME=${WP_DB_NAME}
      - WORDPRESS_DB_USER=${WP_DB_USER}
      - WORDPRESS_DB_PASSWORD=${WP_DB_PASSWORD}
      - WORDPRESS_TABLE_PREFIX=wp_
      - WORDPRESS_DEBUG=false
      # Redis Object Cache
      - WORDPRESS_CONFIG_EXTRA=
          define('WP_REDIS_HOST', 'wp-redis');
          define('WP_REDIS_PORT', 6379);
          define('WP_REDIS_PASSWORD', '${REDIS_PASSWORD_WP}');
          define('WP_REDIS_DATABASE', 0);
          define('WP_CACHE', true);
          define('WP_HOME', 'https://${WP_DOMAIN}');
          define('WP_SITEURL', 'https://${WP_DOMAIN}');
          define('FORCE_SSL_ADMIN', true);
          # Cloudflare R2 / Offload Media
          define('AS3CF_SETTINGS', serialize(array(
              'provider' => 'aws',
              'access-key-id' => '${R2_ACCESS_KEY_ID}',
              'secret-access-key' => '${R2_SECRET_ACCESS_KEY}',
              'bucket' => '${R2_BUCKET}',
              'region' => 'auto',
              'domain' => '${R2_MEDIA_DOMAIN}',
              'enable-object-prefix' => true,
              'object-prefix' => 'wp-content/uploads/',
              'serve-from-s3' => true,
              'remove-local-file' => false,
          )));
    volumes:
      - 'wp-data:/var/www/html'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/wp-login.php"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - wp_net
      - coolify
    labels:
      - traefik.enable=true
      - 'traefik.http.routers.wordpress.rule=Host(`${WP_DOMAIN}`) || Host(`www.${WP_DOMAIN}`)'
      - traefik.http.routers.wordpress.entrypoints=https
      - traefik.http.routers.wordpress.tls=true
      - traefik.http.services.wordpress.loadbalancer.server.port=80

  adminer:
    image: 'adminer:latest'
    container_name: wp-adminer
    restart: unless-stopped
    expose:
      - '8080'
    environment:
      ADMINER_DEFAULT_SERVER: mariadb
    depends_on:
      mariadb:
        condition: service_healthy
    networks:
      - wp_net
      - coolify
    labels:
      - traefik.enable=true
      - traefik.http.routers.wp-adminer.rule=Host(`db.socialstudies.cloud`)
      - traefik.http.routers.wp-adminer.entrypoints=https
      - traefik.http.routers.wp-adminer.tls=true
      - traefik.http.services.wp-adminer.loadbalancer.server.port=8080

  filebrowser:
    image: 'filebrowser/filebrowser:latest'
    container_name: wp-filebrowser
    restart: unless-stopped
    expose:
      - '80'
    volumes:
      - 'wp-data:/srv/wordpress:rw'
    networks:
      - wp_net
      - coolify
    labels:
      - traefik.enable=true
      - traefik.http.routers.wp-filebrowser.rule=Host(`wpfiles.socialstudies.cloud`)
      - traefik.http.routers.wp-filebrowser.entrypoints=https
      - traefik.http.routers.wp-filebrowser.tls=true
      - traefik.http.services.wp-filebrowser.loadbalancer.server.port=80

volumes:
  mariadb-data:
    driver: local
  wp-data:
    driver: local
  redis-data:
    driver: local

networks:
  wp_net:
    driver: bridge
  coolify:
    external: true
